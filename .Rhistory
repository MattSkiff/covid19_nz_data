#covid.df <- rbind(covid.df,covid_p.df)
covid.df$Gender <- covid.df$Sex
covid.df$Gender[covid.df$Gender == ""] <- "Not Reported"
covid.df$Gender <- as.factor(covid.df$Gender)
levels(covid.df$Gender)[levels(covid.df$Gender) == ""] <- "Not Reported"
levels(covid.df$DHB)[levels(covid.df$DHB) == ""] <- "Not Reported"
covid.df$DHB[covid.df$DHB == "TBC"] <- "Not Reported"
covid.df$Age <- as.character(covid.df$`Age group`)
covid.df$Age[covid.df$Age == ""] <- "Not Reported"
covid.df$Age[covid.df$Age == "Teen"] <- "Teens"
covid.df$Age[covid.df$Age == "Unknown"] <- "Not Reported"
covid.df$Age <- as.factor(covid.df$Age)
levels(covid.df$Age)[levels(covid.df$Age) == "Not provided"] <- "Not Reported"
covid.df <- covid.df %>%  mutate(Gender = recode(Gender,
`Male` = "M",
`Female` = "F",
`Not provided` = "Not Reported"))
# sort levels by frequency of DHB
covid.df$DHB <- fct_recode(covid.df$DHB, c("Hawkes Bay" = "Hawke’s Bay"))
covid.df$DHB <- fct_infreq(covid.df$DHB, ordered = NA)
covid.df$Age <- fct_recode(covid.df$Age, c("60s" = "64")) #fct_infreq(covid.df$Age, ordered = NA)
#write.csv(covid.df,"covid19.csv")
#write.csv(covid.df,"covid19.csv")
covid.df$Age <- fct_relevel(covid.df$Age, c("Not Reported","Child","Teens","20s","30s","40s","50s","60s","70s","80s"))
#fct_infreq(covid.df$Age, ordered = NA)
#write.csv(covid.df,"covid19.csv")
covid.df
geo.df <- covid.df
sum(!geo.df$`Last City before NZ` == "")
# remove everything after comma
geo.df$`Last City before NZ` <- gsub(",.*","",geo.df$`Last City before NZ`)
geo.df[geo.df$`Last City before NZ` == "California"] <- "Los Angeles"
joined.df <- left_join(geo.df,cities.df,by = c("Last City before NZ" = "city_ascii"))
joined.df %<>% na.omit()
keep.df <- rbind(
joined.df %>% filter(city == "Cairo" & country == "Egypt"),
joined.df %>% filter(city == "Dublin" & country == "Ireland"),
joined.df %>% filter(city == "Geneva" & admin_name == "Switzerland"),
joined.df %>% filter(city == "London" & admin_name == "United Kingdom"),
joined.df %>% filter(city == "Los Angeles" & admin_name == "California"),
joined.df %>% filter(city == "Manchester" & country == "United Kingdom"),
joined.df %>% filter(city == "Melbourne" & country == "Australia"),
joined.df %>% filter(city == "New York" & country == "United States"),
joined.df %>% filter(city == "Perth" & country == "Australia"),
joined.df %>% filter(city == "Paris" & country == "France"),
joined.df %>% filter(city == "San Francisco" & admin_name == "California"),
joined.df %>% filter(city == "Southampton" & country == "United Kingdom"),
joined.df %>% filter(city == "Sydney" & country == "Australia")
)
joined.df %<>% filter(
city %nin% c(
"Cairo",
"Dublin",
"Geneva",
"London",
"Los Angeles",
"Manchester",
"Melbourne",
"New York",
"Perth",
"Paris",
"San Francisco",
"Southampton",
"Sydney"))
joined.df <- rbind(joined.df,keep.df)
nz_lat.vec <- rep(-39.095963,nrow(joined.df))
nz_lng.vec <- rep(175.776594,nrow(joined.df))
nz_orig.df <- data.frame(lat = nz_lat.vec,
lng = nz_lng.vec,
line = seq_len(nrow(joined.df)),
city = rep("New Zealand",nrow(joined.df)),
id = seq_len(nrow(joined.df)))
joined.df$id <- seq_len(nrow(joined.df))
joined.df %<>% select(lat,lng,id,city) %>% mutate(line = id)
lines.df <- rbind(joined.df,nz_orig.df)
sum(!covid.df$`Last City before NZ` == "")
geo <- list(
showland = TRUE,
showlakes = TRUE,
showcountries = TRUE,
showocean = TRUE,
countrywidth = 0.5,
landcolor = toRGB("black"),
lakecolor = toRGB("grey"),
oceancolor = toRGB("grey"),
projection = list(
type = 'orthographic',
rotation = list(
lon = -100,
lat = 40,
roll = 0
)
),
lonaxis = list(
showgrid = TRUE,
gridcolor = toRGB("gray40"),
gridwidth = 0.5
),
lataxis = list(
showgrid = TRUE,
gridcolor = toRGB("gray40"),
gridwidth = 0.5
)
)
m <- list(
l = 50,
r = 50,
b = 100,
t = 100,
pad = 4
)
fig <- plot_geo(lines.df,color = I("red"))
fig <- fig %>% group_by(line)
fig <- fig %>% add_lines(x = ~lng, y = ~lat,
hoverinfo = "text",
hovertext = paste("City :", lines.df$city,
"<br> Longitude :", lines.df$lng,
"<br> Longitude :", lines.df$lat),
size = I(1))
fig <- fig %>% layout(
showlegend = FALSE, geo = geo,
title = 'COVID19 Cases into NZ : Data from the Ministry of Health'
) %>%
layout(title = list(text = paste0("COVID19 Cases into NZ : Data from the Ministry of Health",
'<br>',
'<sup>',
date_stamp," | Lines do not indicate flight paths | Cities geocoded to most probable location",
'</sup>')),
uniformtext=list(minsize=plotly_text_size, mode='hide'),
margin = m)
fig
sum(!covid.df$`Last City before NZ` == "") / nrow(joined.df)
print(sum(!covid.df$`Last City before NZ` == ""),nrow(joined.df))
as.character(sum(!covid.df$`Last City before NZ` == ""))
as.character(nrow(joined.df)/as.character(sum(!covid.df$`Last City before NZ` == ""))
as.character(nrow(joined.df))/as.character(sum(!covid.df$`Last City before NZ` == ""))
runApp()
source("global.R")
runApp()
runApp()
runApp()
runApp()
rsconnect::deployApp(appName = "covid_nz",forceUpdate = T,launch.browser = F)
?add_lines
add_lines(dg)
add_lines(hovertes = "")
runApp()
cities.df <- read.csv('worldcities.csv')
url <- "https://www.health.govt.nz/our-work/diseases-and-conditions/covid-19-novel-coronavirus/covid-19-current-cases/covid-19-current-cases-details"
#<- url %>%
covid.ls <- read_html(url) %>% # "23_03_2020.html" # for static
html_table()
covid.df <- covid.ls[[1]]
#covid_p.df <- covid.ls[[2]]
#covid_p.df$Case <- paste(covid_p.df$Case,"probable")
#covid.df <- rbind(covid.df,covid_p.df)
covid.df$Gender <- covid.df$Sex
covid.df$Gender[covid.df$Gender == ""] <- "Not Reported"
covid.df$Gender <- as.factor(covid.df$Gender)
levels(covid.df$Gender)[levels(covid.df$Gender) == ""] <- "Not Reported"
levels(covid.df$DHB)[levels(covid.df$DHB) == ""] <- "Not Reported"
covid.df$DHB[covid.df$DHB == "TBC"] <- "Not Reported"
covid.df$Age <- as.character(covid.df$`Age group`)
covid.df$Age[covid.df$Age == ""] <- "Not Reported"
covid.df$Age[covid.df$Age == "Teen"] <- "Teens"
covid.df$Age[covid.df$Age == "Unknown"] <- "Not Reported"
covid.df$Age <- as.factor(covid.df$Age)
levels(covid.df$Age)[levels(covid.df$Age) == "Not provided"] <- "Not Reported"
covid.df <- covid.df %>%  mutate(Gender = recode(Gender,
`Male` = "M",
`Female` = "F",
`Not provided` = "Not Reported"))
# sort levels by frequency of DHB
covid.df$DHB <- fct_recode(covid.df$DHB, c("Hawkes Bay" = "Hawke’s Bay"))
covid.df$DHB <- fct_infreq(covid.df$DHB, ordered = NA)
covid.df$Age <- fct_recode(covid.df$Age, c("60s" = "64")) #fct_infreq(covid.df$Age, ordered = NA)
#write.csv(covid.df,"covid19.csv")
#write.csv(covid.df,"covid19.csv")
covid.df$Age <- fct_relevel(covid.df$Age, c("Not Reported","Child","Teens","20s","30s","40s","50s","60s","70s","80s"))
#fct_infreq(covid.df$Age, ordered = NA)
#write.csv(covid.df,"covid19.csv")
covid.df
geo.df <- covid.df
sum(!geo.df$`Last City before NZ` == "")
# remove everything after comma
geo.df$`Last City before NZ` <- gsub(",.*","",geo.df$`Last City before NZ`)
geo.df[geo.df$`Last City before NZ` == "California",]$`Last City before NZ`  <- "Los Angeles"
joined.df <- left_join(geo.df,cities.df,by = c("Last City before NZ" = "city_ascii"))
joined.df %<>% na.omit()
keep.df <- rbind(
joined.df %>% filter(city == "Cairo" & country == "Egypt"),
joined.df %>% filter(city == "Dublin" & country == "Ireland"),
joined.df %>% filter(city == "Geneva" & admin_name == "Switzerland"),
joined.df %>% filter(city == "London" & admin_name == "United Kingdom"),
joined.df %>% filter(city == "Los Angeles" & admin_name == "California"),
joined.df %>% filter(city == "Manchester" & country == "United Kingdom"),
joined.df %>% filter(city == "Melbourne" & country == "Australia"),
joined.df %>% filter(city == "New York" & country == "United States"),
joined.df %>% filter(city == "Perth" & country == "Australia"),
joined.df %>% filter(city == "Paris" & country == "France"),
joined.df %>% filter(city == "San Francisco" & admin_name == "California"),
joined.df %>% filter(city == "Southampton" & country == "United Kingdom"),
joined.df %>% filter(city == "Sydney" & country == "Australia")
)
joined.df %<>% filter(
city %nin% c(
"Cairo",
"Dublin",
"Geneva",
"London",
"Los Angeles",
"Manchester",
"Melbourne",
"New York",
"Perth",
"Paris",
"San Francisco",
"Southampton",
"Sydney"))
joined.df <- rbind(joined.df,keep.df)
joined.df
joined.df %>% group_by(city) %>% tally()
nz_lat.vec <- rep(-39.095963,nrow(joined.df))
nz_lng.vec <- rep(175.776594,nrow(joined.df))
nz_orig.df <- data.frame(lat = nz_lat.vec,
lng = nz_lng.vec,
line = seq_len(nrow(joined.df)),
city = rep("New Zealand",nrow(joined.df)),
id = seq_len(nrow(joined.df)))
joined.df$id <- seq_len(nrow(joined.df))
joined.df %<>% select(lat,lng,id,city) %>% mutate(line = id)
lines.df <- rbind(joined.df,nz_orig.df)
joined.df
geo.df <- covid.df
# number of known locations
sum(!geo.df$`Last City before NZ` == "")
# remove everything after comma
geo.df$`Last City before NZ` <- gsub(",.*","",geo.df$`Last City before NZ`)
geo.df[geo.df$`Last City before NZ` == "California",]$`Last City before NZ`  <- "Los Angeles"
joined.df <- left_join(geo.df,cities.df,by = c("Last City before NZ" = "city_ascii"))
joined.df %<>% na.omit()
keep.df <- rbind(
joined.df %>% filter(city == "Cairo" & country == "Egypt"),
joined.df %>% filter(city == "Dublin" & country == "Ireland"),
joined.df %>% filter(city == "Geneva" & admin_name == "Switzerland"),
joined.df %>% filter(city == "London" & admin_name == "United Kingdom"),
joined.df %>% filter(city == "Los Angeles" & admin_name == "California"),
joined.df %>% filter(city == "Manchester" & country == "United Kingdom"),
joined.df %>% filter(city == "Melbourne" & country == "Australia"),
joined.df %>% filter(city == "New York" & country == "United States"),
joined.df %>% filter(city == "Perth" & country == "Australia"),
joined.df %>% filter(city == "Paris" & country == "France"),
joined.df %>% filter(city == "San Francisco" & admin_name == "California"),
joined.df %>% filter(city == "Southampton" & country == "United Kingdom"),
joined.df %>% filter(city == "Sydney" & country == "Australia")
)
joined.df %<>% filter(
city %nin% c(
"Cairo",
"Dublin",
"Geneva",
"London",
"Los Angeles",
"Manchester",
"Melbourne",
"New York",
"Perth",
"Paris",
"San Francisco",
"Southampton",
"Sydney"))
joined.df <- rbind(joined.df,keep.df)
joined.df %>% group_by(city,lat,lng)
joined.df %>% group_by(city,lat,lng) %>% tally()
geo.df <- covid.df
# number of known locations
sum(!geo.df$`Last City before NZ` == "")
# remove everything after comma
geo.df$`Last City before NZ` <- gsub(",.*","",geo.df$`Last City before NZ`)
geo.df[geo.df$`Last City before NZ` == "California",]$`Last City before NZ`  <- "Los Angeles"
joined.df <- left_join(geo.df,cities.df,by = c("Last City before NZ" = "city_ascii"))
joined.df %<>% na.omit()
keep.df <- rbind(
joined.df %>% filter(city == "Cairo" & country == "Egypt"),
joined.df %>% filter(city == "Dublin" & country == "Ireland"),
joined.df %>% filter(city == "Geneva" & admin_name == "Switzerland"),
joined.df %>% filter(city == "London" & admin_name == "United Kingdom"),
joined.df %>% filter(city == "Los Angeles" & admin_name == "California"),
joined.df %>% filter(city == "Manchester" & country == "United Kingdom"),
joined.df %>% filter(city == "Melbourne" & country == "Australia"),
joined.df %>% filter(city == "New York" & country == "United States"),
joined.df %>% filter(city == "Perth" & country == "Australia"),
joined.df %>% filter(city == "Paris" & country == "France"),
joined.df %>% filter(city == "San Francisco" & admin_name == "California"),
joined.df %>% filter(city == "Southampton" & country == "United Kingdom"),
joined.df %>% filter(city == "Sydney" & country == "Australia")
)
joined.df %<>% filter(
city %nin% c(
"Cairo",
"Dublin",
"Geneva",
"London",
"Los Angeles",
"Manchester",
"Melbourne",
"New York",
"Perth",
"Paris",
"San Francisco",
"Southampton",
"Sydney"))
joined.df <- rbind(joined.df,keep.df)
tally.df <- joined.df %>% group_by(city,lat,lng) %>% tally()
nz_lat.vec <- rep(-39.095963,nrow(tally.df))
nz_lng.vec <- rep(175.776594,nrow(tally.df))
nz_orig.df <- data.frame(lat = nz_lat.vec,
lng = nz_lng.vec,
line = seq_len(nrow(tally.df)),
city = rep("New Zealand",nrow(tally.df)),
id = seq_len(nrow(tally.df)))
tally.df$id <- seq_len(nrow(tally.df))
joined.df %<>% select(lat,lng,id,city,n) %>% mutate(line = id)
nz_orig.df$n <- tally.df$n
tally.df %<>% select(lat,lng,id,city,n) %>% mutate(line = id)
nz_orig.df$n <- tally.df$n
lines.df <- rbind(tally.df,nz_orig.df)
runApp()
lines.df
geo.df <- covid.df
sum(!geo.df$`Last City before NZ` == "")
# remove everything after comma
geo.df$`Last City before NZ` <- gsub(",.*","",geo.df$`Last City before NZ`)
geo.df[geo.df$`Last City before NZ` == "California",]$`Last City before NZ`  <- "Los Angeles"
joined.df <- left_join(geo.df,cities.df,by = c("Last City before NZ" = "city_ascii"))
joined.df %<>% na.omit()
keep.df <- rbind(
joined.df %>% filter(city == "Cairo" & country == "Egypt"),
joined.df %>% filter(city == "Dublin" & country == "Ireland"),
joined.df %>% filter(city == "Geneva" & admin_name == "Switzerland"),
joined.df %>% filter(city == "London" & admin_name == "United Kingdom"),
joined.df %>% filter(city == "Los Angeles" & admin_name == "California"),
joined.df %>% filter(city == "Manchester" & country == "United Kingdom"),
joined.df %>% filter(city == "Melbourne" & country == "Australia"),
joined.df %>% filter(city == "New York" & country == "United States"),
joined.df %>% filter(city == "Perth" & country == "Australia"),
joined.df %>% filter(city == "Paris" & country == "France"),
joined.df %>% filter(city == "San Francisco" & admin_name == "California"),
joined.df %>% filter(city == "Southampton" & country == "United Kingdom"),
joined.df %>% filter(city == "Sydney" & country == "Australia")
)
joined.df %<>% filter(
city %nin% c(
"Cairo",
"Dublin",
"Geneva",
"London",
"Los Angeles",
"Manchester",
"Melbourne",
"New York",
"Perth",
"Paris",
"San Francisco",
"Southampton",
"Sydney"))
joined.df <- rbind(joined.df,keep.df)
tally.df <- joined.df %>% group_by(city,lat,lng) %>% tally()
nz_lat.vec <- rep(-39.095963,nrow(tally.df))
nz_lng.vec <- rep(175.776594,nrow(tally.df))
nz_orig.df <- data.frame(lat = nz_lat.vec,
lng = nz_lng.vec,
line = seq_len(nrow(tally.df)),
city = rep("New Zealand",nrow(tally.df)),
id = seq_len(nrow(tally.df)))
tally.df$id <- seq_len(nrow(tally.df))
tally.df %<>% select(lat,lng,id,city,n) %>% mutate(line = id)
nz_orig.df$n <- tally.df$n
head(nz_orig.df)
head(tally.df)
tally.df %<>% select(lat,lng,city,id,n) %>% mutate(line = id)
tally.df
nz_orig.df$n <- tally.df$n
lines.df <- rbind(tally.df,nz_orig.df)
lines.df
head(tally.df)
head(nz_orig.df)
tally.df %<>% select(lat,lng,line,city,id,n) %>% mutate(line = id)
nz_orig.df$n <- tally.df$n
lines.df <- rbind(tally.df,nz_orig.df)
lines.df
geo.df <- covid.df
# number of known locations
sum(!geo.df$`Last City before NZ` == "")
# remove everything after comma
geo.df$`Last City before NZ` <- gsub(",.*","",geo.df$`Last City before NZ`)
geo.df[geo.df$`Last City before NZ` == "California",]$`Last City before NZ`  <- "Los Angeles"
joined.df <- left_join(geo.df,cities.df,by = c("Last City before NZ" = "city_ascii"))
joined.df %<>% na.omit()
keep.df <- rbind(
joined.df %>% filter(city == "Cairo" & country == "Egypt"),
joined.df %>% filter(city == "Dublin" & country == "Ireland"),
joined.df %>% filter(city == "Geneva" & admin_name == "Switzerland"),
joined.df %>% filter(city == "London" & admin_name == "United Kingdom"),
joined.df %>% filter(city == "Los Angeles" & admin_name == "California"),
joined.df %>% filter(city == "Manchester" & country == "United Kingdom"),
joined.df %>% filter(city == "Melbourne" & country == "Australia"),
joined.df %>% filter(city == "New York" & country == "United States"),
joined.df %>% filter(city == "Perth" & country == "Australia"),
joined.df %>% filter(city == "Paris" & country == "France"),
joined.df %>% filter(city == "San Francisco" & admin_name == "California"),
joined.df %>% filter(city == "Southampton" & country == "United Kingdom"),
joined.df %>% filter(city == "Sydney" & country == "Australia")
)
joined.df %<>% filter(
city %nin% c(
"Cairo",
"Dublin",
"Geneva",
"London",
"Los Angeles",
"Manchester",
"Melbourne",
"New York",
"Perth",
"Paris",
"San Francisco",
"Southampton",
"Sydney"))
joined.df <- rbind(joined.df,keep.df)
tally.df <- joined.df %>% group_by(city,lat,lng) %>% tally()
nz_lat.vec <- rep(-39.095963,nrow(tally.df))
nz_lng.vec <- rep(175.776594,nrow(tally.df))
nz_orig.df <- data.frame(lat = nz_lat.vec,
lng = nz_lng.vec,
line = seq_len(nrow(tally.df)),
city = rep("New Zealand",nrow(tally.df)),
id = seq_len(nrow(tally.df)))
tally.df$id <- seq_len(nrow(tally.df))
tally.df %<>% select(lat,lng,line,city,id,n) %>% mutate(line = id)
nz_orig.df$n <- tally.df$n
lines.df <- rbind(tally.df,nz_orig.df)
geo.df <- covid.df
# number of known locations
sum(!geo.df$`Last City before NZ` == "")
# remove everything after comma
geo.df$`Last City before NZ` <- gsub(",.*","",geo.df$`Last City before NZ`)
geo.df[geo.df$`Last City before NZ` == "California",]$`Last City before NZ`  <- "Los Angeles"
joined.df <- left_join(geo.df,cities.df,by = c("Last City before NZ" = "city_ascii"))
joined.df %<>% na.omit()
keep.df <- rbind(
joined.df %>% filter(city == "Cairo" & country == "Egypt"),
joined.df %>% filter(city == "Dublin" & country == "Ireland"),
joined.df %>% filter(city == "Geneva" & admin_name == "Switzerland"),
joined.df %>% filter(city == "London" & admin_name == "United Kingdom"),
joined.df %>% filter(city == "Los Angeles" & admin_name == "California"),
joined.df %>% filter(city == "Manchester" & country == "United Kingdom"),
joined.df %>% filter(city == "Melbourne" & country == "Australia"),
joined.df %>% filter(city == "New York" & country == "United States"),
joined.df %>% filter(city == "Perth" & country == "Australia"),
joined.df %>% filter(city == "Paris" & country == "France"),
joined.df %>% filter(city == "San Francisco" & admin_name == "California"),
joined.df %>% filter(city == "Southampton" & country == "United Kingdom"),
joined.df %>% filter(city == "Sydney" & country == "Australia")
)
joined.df %<>% filter(
city %nin% c(
"Cairo",
"Dublin",
"Geneva",
"London",
"Los Angeles",
"Manchester",
"Melbourne",
"New York",
"Perth",
"Paris",
"San Francisco",
"Southampton",
"Sydney"))
joined.df <- rbind(joined.df,keep.df)
tally.df <- joined.df %>% group_by(city,lat,lng) %>% tally()
nz_lat.vec <- rep(-39.095963,nrow(tally.df))
nz_lng.vec <- rep(175.776594,nrow(tally.df))
nz_orig.df <- data.frame(lat = nz_lat.vec,
lng = nz_lng.vec,
line = seq_len(nrow(tally.df)),
city = rep("New Zealand",nrow(tally.df)),
id = seq_len(nrow(tally.df)))
tally.df$id <- seq_len(nrow(tally.df))
tally.df %<>% mutate(line = id) %>% select(lat,lng,line,city,id,n)
nz_orig.df$n <- tally.df$n
lines.df <- rbind(tally.df,nz_orig.df)
lines.df
nz_orig.df
head(nz_orig.df)
head(tally.df)
lines.df <- rbind(as.data.frame(tally.df),nz_orig.df)
lines.df
runApp()
runApp()
runApp()
runApp()
nrow(lines.df)
lines.df
lines.df[1:nrow(lines.df)/2,]
runApp()
runApp()
lines.df[1:nrow(lines.df)/2,]
runApp()
rsconnect::deployApp(appName = "covid_nz",forceUpdate = T,launch.browser = F)
rsconnect::deployApp(appName = "covid_nz",forceUpdate = T,launch.browser = F)
